<html>

<head>
    <title>read-excel-file</title>
    <meta charset="utf-8">
     <script src="./lib/js/csv-to-json.js"></script>
    
    <link rel="stylesheet" href="lib/css/excel.css">
    <style>
        .file-dropzone {
            display:block;
            border:4px dashed #aaa;
            background-color: #dde;
            border-radius: 20px;
            overflow: hidden;
            height:200px;
            min-height:200px;
            width:400px;
            min-width:400px;
            position:relative;
        }

        .file-dropzone:after {
            content:'Drag & Drop your JIRA .CSV exports here!';
            position:absolute;
            width:80%;
            line-height: 1.6;
            height:100%;
            text-align: center;
            font-size:26px;
            padding:10%;
        }

        [type='file'] {
            position:absolute;
            margin-left:-400px;
        }
    </style>
</head>

<body>
    <label for="reportStartDate" class="startDateLabel">Start Date:</label>
    <input id="reportStartDate" name="startDate" type="date" class="datepicker" autocomplete="false" />
    
    <label id="file-dropzone" class="file-dropzone" for="input">
        <input type="file" id="input" name="input" multiple>
    </label>

    <div class="settings-panel">
        <input type="checkbox" id="option-box-1" class="option-box" name="option-box-1" checked onchange="handleSettings()">
        <label for="option-box-1" class="option-label">JIRA Filename <i>format assumed to be default for imported files?</i></label>
        <input type="checkbox" id="option-box-2" class="option-box" name="option-box-2" checked onchange="handleSettings()">
        <label for="option-box-2" class="option-label">ISO Date/Time <i>promanently featured in filename?</i></label>
        <input type="checkbox" id="option-box-3" class="option-box" name="option-box-3" checked onchange="handleSettings()">
        <label for="option-box-3" class="option-label">Auto-sort <i>files by on name when first loaded?</i></label>
        <button onClick='runReport()'>Run Report</button>
    </div>
    <ul class="has-draggable-children"></ol>
    <div id="result-table"></div>
    <pre id="result"></pre>
    
    <script>
    const d            = document
         ,qs           = (s)=>d.querySelector(s)
         ,qsa          = (s)=>[...d.querySelectorAll(s)]
         ,input        = document.getElementById('input')
         ,sortableList = qs('.has-draggable-children');

    let fileBuffer = []
       ,namedFiles = []
       ,OPsettings = {}
       ,COMBD_DATA = []
       ,ISSUE_KEYS = [];

    const establishDragDropList = (listClass) => {
       Array.prototype.map.call(
          document.getElementsByClassName(listClass),
          list => {
             Array.prototype.map.call(list.children, item => {
                bindDragDropListeners(item);
             });
          }
       );
    }

    const bindDragDropListeners = (obj) => {
       const drag = (e, trg = e.target, parList = trg.parentNode) => {
          trg.className += " drag-sort-active";
          let swapobj = document.elementFromPoint(event.clientX, event.clientY) || trg;

          if (parList === swapobj.parentNode) {
             // Thereby constraining the drop to the same list
             swapobj = (swapobj !== trg.nextSibling) ? swapobj : swapobj.nextSibling;
             parList.insertBefore(trg, swapobj);
          }
       };
       const drop = (e, trg = e.target) => trg.className = trg.className.replace(/(\s+)?drag-sort-active(\s+)?/g, "");


       obj.setAttribute("draggable", true);
       obj.addEventListener("drag", drag);
       obj.addEventListener("drop", drop);
       obj.addEventListener("dragend", drop);
    }

    const ingestFileData = (fileObj, name, date, cb) => {
        const appendToBuffer = (obj, index=null) => (index==null) ? fileBuffer.push(obj) : fileBuffer[index]=obj;
        console.groupCollapsed('Ingesting file ' + name + '...')
        var reader    = new FileReader();                               // Instantiate a new file reader...
                                                                        //   ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  ⌢  
        reader.onload = function(progressEvent) {                       //    ... Add a listener to observe once it's finished loading.
            var opJSON = CSV.parse(this.result);                        //    Parse the .CSV file input...
            appendToBuffer(opJSON);                                     //    ... and add it to the global variable containing file data,
            let keySet = JSON.stringify(opJSON,['Issue key'])           //    ... convert the resultant JSON to a string containing ONLY the 'Issue key' column...
                             .match(/DIGTDEV-\d{4,6}/g)                 //    ... and then search the pattern DIGTDEV-####(##) out (any 4-6-digit number)
            ISSUE_KEYS = [...new Set([...ISSUE_KEYS, ...keySet])]       //    ... combine keySet and ISSUE_KEYS, remove duplicates, and convert back to an array.
            console.log(name, '-----------------------------------\nopJSON ============================\n', opJSON, '-----------------------------------\nISSUE_KEYS (de-duped) ============================\n', ISSUE_KEYS);
        };                                                              // ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  ⌣  
        reader.readAsText(fileObj);                                     // ... And read the file specified.
    }

    const unifyFileData = () => {
        COMBD_DATA = [];
        ISSUE_KEYS = []; 
        DEBUG_DATA = [];
        console.group('Parsing CSV contents into a single structure...');
        fileBuffer.flat().forEach(r => (ISSUE_KEYS.push(r['Issue key']) 
                                    && (COMBD_DATA[r['Issue key']] = new Array(fileBuffer.length).fill(''))
                                    && (DEBUG_DATA[r['Issue key']] = new Array(fileBuffer.length).fill('')))
        );
        console.log(ISSUE_KEYS.length, 'total records found!',
                    '\n     Reducing...');
        ISSUE_KEYS = [...new Set(ISSUE_KEYS)];
        console.log('Unique issues from specified files: ', ISSUE_KEYS.join(', '), 
                    '\n     Constructing combined dataset...');

       for(files in fileBuffer){
            let file = fileBuffer[files];
            console.log('   - Ingesting file #' + files + ': ', file);
            file.forEach(f=>{
                if(f && f['Issue key'] && f['Issue key'] != null && f['Issue key'] !== ''){ 
                    COMBD_DATA[f['Issue key']][files] = f;
                    DEBUG_DATA[f['Issue key']][files] = JSON.stringify(f);
                }
            });
        }
        console.info('Dataset unified. Current state:');
        console.log('RAW DATA ', COMBD_DATA);
        console.log('RAW DATA ', JSON.stringify(Object.entries(COMBD_DATA)));
        console.table(DEBUG_DATA);

        console.groupEnd();
        return true;
    }


    const ructDraggableOutput = response => {
        console.log('Constructing drag/drop ui...');
        let opStr = '';
        for (var i = 0; i < 10; i++) {
            if(i < namedFiles.length){
                let fileName = namedFiles[i];
                let fileDate = fileName.replace(/^(.+)(\d{4})-(\d\d)-(\d\d)T(\d\d)_(\d\d)_(\d\d)(-\d{4})(.*)?$/, '$3-$4-$2, $5:$6');
                console.log('   - Creating draggable DOM node for ' + fileName);
                opStr += `<li class="draggable" data-drop="true" draggable="true">${fileName}</li>`
            }else{
                opStr += `<li class="not-draggable placeholder" data-slot="${i}">No file specified (click to add!)</li>`;
            }
        }
        console.log('   - Clearing current DOM structure of list...');
        sortableList.innerHTML = '';
        sortableList.insertAdjacentHTML('beforeEnd', opStr);
        console.log('   - Inserting new draggable DOM structure...');
        addDropHandlers();
        return Promise.resolve(response);
    }

    input.addEventListener('change', () => {
        console.group('Files selected! Beginning processing tasks...');
        const parseFileNames = response => {
            console.log('- Parsing & Sorting File Names...')
            for(let i=0; i<input.files.length; i++)     namedFiles.push(input.files[i].name);
            if(OPsettings.autoSorting && input.files)   namedFiles = namedFiles.sort();
            console.log('   -', namedFiles.join('\n   - '));
            return Promise.resolve(response)
            return Promise.reject(new Error(response.statusText))
        }

        return parseFileNames()
            .then(ructDraggableOutput)
            .then(()=>establishDragDropList("has-draggable-children"));
    });

    const runReport = () => {
        unifyFileData();
    }
    
    const handleSettings = () => {
        console.log('Reading User Settings...');
        OPsettings.isDefFormat = document.getElementById("option-box-1").checked;
        OPsettings.isoDateTime = document.getElementById("option-box-2").checked;
        OPsettings.autoSorting = document.getElementById("option-box-3").checked;

        document.querySelector('ol').className += OPsettings.isoDateTime ? ' withDate' : '';
    }
    
    (init = () => {
        handleSettings();
    })();
    </script>
</body>

</html>